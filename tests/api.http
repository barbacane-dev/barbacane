### Barbacane API Test Scenarios (M2-M4)
### Usage: Start gateway first with:
###   cargo build
###   ./target/debug/barbacane compile --spec tests/fixtures/validation.yaml --output /tmp/test.bca
###   ./target/debug/barbacane serve --artifact /tmp/test.bca --dev
###
### Note: Mock dispatcher now runs as a WASM plugin (M4)

@baseUrl = http://localhost:8080

### ================================
### Health & Basic Routes
### ================================

### Health check (should return 200)
GET {{baseUrl}}/health

### Internal health endpoint
GET {{baseUrl}}/__barbacane/health


### Internal spec endpoint
GET {{baseUrl}}/__barbacane/openapi

### ================================
### Request Body Validation
### ================================

### Missing required body (400)
POST {{baseUrl}}/users
Content-Type: application/json

### Missing required field 'name' (400)
POST {{baseUrl}}/users
Content-Type: application/json

{"email": "test@example.com"}

### Valid request body (201)
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "Test User", "email": "test@example.com"}

### Valid request with all fields (201)
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "Test User", "email": "test@example.com", "age": 25}

### ================================
### Content-Type Validation
### ================================

### Wrong content type (400)
POST {{baseUrl}}/users
Content-Type: text/plain

name=Test

### Wrong content type - XML (400)
POST {{baseUrl}}/users
Content-Type: application/xml

<user><name>Test</name></user>

### ================================
### Header Validation
### ================================

### Missing required X-Request-ID header (400)
PUT {{baseUrl}}/users/123
Content-Type: application/json

{"name": "Updated"}

### With required X-Request-ID header (200)
PUT {{baseUrl}}/users/123
Content-Type: application/json
X-Request-ID: abc-123

{"name": "Updated"}

### ================================
### Query Parameter Validation
### ================================

### No query params (200)
GET {{baseUrl}}/users

### Valid query params (200)
GET {{baseUrl}}/users?page=1&limit=10

### Valid page only (200)
GET {{baseUrl}}/users?page=5

### Valid limit only (200)
GET {{baseUrl}}/users?limit=50

### Invalid page format - zero (400)
GET {{baseUrl}}/users?page=0

### Invalid page format - negative (400)
GET {{baseUrl}}/users?page=-1

### Invalid page format - letters (400)
GET {{baseUrl}}/users?page=abc

### Invalid limit - over 100 (400)
GET {{baseUrl}}/users?limit=101

### ================================
### Path Parameter Validation
### ================================

### Valid path param (200)
GET {{baseUrl}}/users/123

### ================================
### 404 & 405 Errors
### ================================

### Non-existent route (404)
GET {{baseUrl}}/nonexistent

### Method not allowed (405)
DELETE {{baseUrl}}/health

### ================================
### JSON Schema Validation
### ================================

### Invalid JSON syntax (400)
POST {{baseUrl}}/users
Content-Type: application/json

{invalid json}

### Wrong type for field (400)
POST {{baseUrl}}/users
Content-Type: application/json

{"name": 123, "email": "test@example.com"}

### Name too short - minLength violation (400 - if minLength is enforced)
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "", "email": "test@example.com"}

### ================================================================
### M4: Mock Dispatcher (WASM Plugin)
### ================================================================
### The mock dispatcher is now a WASM plugin that returns static responses
### configured in the OpenAPI spec. Features:
### - Custom status codes (status)
### - Custom response bodies (body)
### - Custom headers (headers)
### - Content-Type configuration (content_type)

### Mock health check - returns {"status":"ok"} (WASM plugin)
# Expected: 200 OK
GET {{baseUrl}}/health

###

### Mock user list - returns {"users":[]}
# Expected: 200 OK
GET {{baseUrl}}/users

###

### Mock create user - returns {"id":"123"} with 201
# Expected: 201 Created
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "Test User", "email": "test@example.com"}

###

### Mock get user - UUID format required
# Expected: 200 OK
GET {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000

###

### Mock update user - returns {"updated":true}
# Expected: 200 OK
PUT {{baseUrl}}/users/123
Content-Type: application/json
X-Request-ID: req-abc-123

{"name": "Updated User"}

###

### ================================================================
### M4: HTTP Upstream Proxy Tests
### ================================================================
### Usage: Start gateway with proxy.yaml:
###   cargo build
###   ./target/debug/barbacane compile --spec tests/fixtures/proxy.yaml --output /tmp/proxy.bca
###   ./target/debug/barbacane serve --artifact /tmp/proxy.bca --dev --allow-plaintext-upstream

### Local health check (mock dispatcher via WASM)
GET {{baseUrl}}/health

### ================================
### Proxy to httpbin.org
### ================================

### Proxy GET - returns request info
GET {{baseUrl}}/proxy/get

### Proxy GET - returns request headers
GET {{baseUrl}}/proxy/headers

### Proxy GET - returns client IP
GET {{baseUrl}}/proxy/ip

### Proxy GET - returns user agent
GET {{baseUrl}}/proxy/user-agent

### Proxy POST - echo JSON body
POST {{baseUrl}}/proxy/post
Content-Type: application/json

{"message": "Hello from Barbacane!", "timestamp": "2024-01-01T00:00:00Z"}

### Proxy POST - complex JSON
POST {{baseUrl}}/proxy/post
Content-Type: application/json

{
  "user": {
    "name": "Alice",
    "email": "alice@example.com"
  },
  "items": ["apple", "banana", "cherry"],
  "count": 3
}

### ================================
### Status Code Passthrough
### ================================

### Upstream returns 200
GET {{baseUrl}}/status/200

### Upstream returns 201
GET {{baseUrl}}/status/201

### Upstream returns 400
GET {{baseUrl}}/status/400

### Upstream returns 404
GET {{baseUrl}}/status/404

### Upstream returns 500
GET {{baseUrl}}/status/500

### ================================
### Timeout Testing
### ================================

### Fast response (2 seconds, within 5s timeout)
GET {{baseUrl}}/delay/2

### Slow response (6 seconds, exceeds 5s timeout -> 504)
GET {{baseUrl}}/delay/6
