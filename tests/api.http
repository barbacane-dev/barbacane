### Barbacane API Test Scenarios (M2-M11)
### Usage: Start gateway first with:
###   cargo build
###   ./target/debug/barbacane compile --spec tests/fixtures/validation.yaml --output /tmp/test.bca
###   ./target/debug/barbacane serve --artifact /tmp/test.bca --dev
###
### Note: Mock dispatcher now runs as a WASM plugin (M4)

@baseUrl = http://localhost:8080

### ================================
### Health & Basic Routes
### ================================

### Health check (should return 200)
GET {{baseUrl}}/health

### Internal health endpoint
GET {{baseUrl}}/__barbacane/health


### Internal spec endpoint
GET {{baseUrl}}/__barbacane/openapi

### ================================
### Request Body Validation
### ================================

### Missing required body (400)
POST {{baseUrl}}/users
Content-Type: application/json

### Missing required field 'name' (400)
POST {{baseUrl}}/users
Content-Type: application/json

{"email": "test@example.com"}

### Valid request body (201)
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "Test User", "email": "test@example.com"}

### Valid request with all fields (201)
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "Test User", "email": "test@example.com", "age": 25}

### ================================
### Content-Type Validation
### ================================

### Wrong content type (400)
POST {{baseUrl}}/users
Content-Type: text/plain

name=Test

### Wrong content type - XML (400)
POST {{baseUrl}}/users
Content-Type: application/xml

<user><name>Test</name></user>

### ================================
### Header Validation
### ================================

### Missing required X-Request-ID header (400)
PUT {{baseUrl}}/users/123
Content-Type: application/json

{"name": "Updated"}

### With required X-Request-ID header (200)
PUT {{baseUrl}}/users/123
Content-Type: application/json
X-Request-ID: abc-123

{"name": "Updated"}

### ================================
### Query Parameter Validation
### ================================

### No query params (200)
GET {{baseUrl}}/users

### Valid query params (200)
GET {{baseUrl}}/users?page=1&limit=10

### Valid page only (200)
GET {{baseUrl}}/users?page=5

### Valid limit only (200)
GET {{baseUrl}}/users?limit=50

### Invalid page format - zero (400)
GET {{baseUrl}}/users?page=0

### Invalid page format - negative (400)
GET {{baseUrl}}/users?page=-1

### Invalid page format - letters (400)
GET {{baseUrl}}/users?page=abc

### Invalid limit - over 100 (400)
GET {{baseUrl}}/users?limit=101

### ================================
### Path Parameter Validation
### ================================

### Valid path param (200)
GET {{baseUrl}}/users/123

### ================================
### 404 & 405 Errors
### ================================

### Non-existent route (404)
GET {{baseUrl}}/nonexistent

### Method not allowed (405)
DELETE {{baseUrl}}/health

### ================================
### JSON Schema Validation
### ================================

### Invalid JSON syntax (400)
POST {{baseUrl}}/users
Content-Type: application/json

{invalid json}

### Wrong type for field (400)
POST {{baseUrl}}/users
Content-Type: application/json

{"name": 123, "email": "test@example.com"}

### Name too short - minLength violation (400 - if minLength is enforced)
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "", "email": "test@example.com"}

### ================================================================
### M4: Mock Dispatcher (WASM Plugin)
### ================================================================
### The mock dispatcher is now a WASM plugin that returns static responses
### configured in the OpenAPI spec. Features:
### - Custom status codes (status)
### - Custom response bodies (body)
### - Custom headers (headers)
### - Content-Type configuration (content_type)

### Mock health check - returns {"status":"ok"} (WASM plugin)
# Expected: 200 OK
GET {{baseUrl}}/health

###

### Mock user list - returns {"users":[]}
# Expected: 200 OK
GET {{baseUrl}}/users

###

### Mock create user - returns {"id":"123"} with 201
# Expected: 201 Created
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "Test User", "email": "test@example.com"}

###

### Mock get user - UUID format required
# Expected: 200 OK
GET {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000

###

### Mock update user - returns {"updated":true}
# Expected: 200 OK
PUT {{baseUrl}}/users/123
Content-Type: application/json
X-Request-ID: req-abc-123

{"name": "Updated User"}

###

### ================================================================
### M4: HTTP Upstream Proxy Tests
### ================================================================
### Usage: Start gateway with proxy.yaml:
###   cargo build
###   ./target/debug/barbacane compile --spec tests/fixtures/proxy.yaml --output /tmp/proxy.bca
###   ./target/debug/barbacane serve --artifact /tmp/proxy.bca --dev --allow-plaintext-upstream

### Local health check (mock dispatcher via WASM)
GET {{baseUrl}}/health

### ================================
### Proxy to httpbin.org
### ================================

### Proxy GET - returns request info
GET {{baseUrl}}/proxy/get

### Proxy GET - returns request headers
GET {{baseUrl}}/proxy/headers

### Proxy GET - returns client IP
GET {{baseUrl}}/proxy/ip

### Proxy GET - returns user agent
GET {{baseUrl}}/proxy/user-agent

### Proxy POST - echo JSON body
POST {{baseUrl}}/proxy/post
Content-Type: application/json

{"message": "Hello from Barbacane!", "timestamp": "2024-01-01T00:00:00Z"}

### Proxy POST - complex JSON
POST {{baseUrl}}/proxy/post
Content-Type: application/json

{
  "user": {
    "name": "Alice",
    "email": "alice@example.com"
  },
  "items": ["apple", "banana", "cherry"],
  "count": 3
}

### ================================
### Status Code Passthrough
### ================================

### Upstream returns 200
GET {{baseUrl}}/status/200

### Upstream returns 201
GET {{baseUrl}}/status/201

### Upstream returns 400
GET {{baseUrl}}/status/400

### Upstream returns 404
GET {{baseUrl}}/status/404

### Upstream returns 500
GET {{baseUrl}}/status/500

### ================================
### Timeout Testing
### ================================

### Fast response (2 seconds, within 5s timeout)
GET {{baseUrl}}/delay/2

### Slow response (6 seconds, exceeds 5s timeout -> 504)
GET {{baseUrl}}/delay/6

### ================================================================
### M11: API Lifecycle / Deprecation Tests
### ================================================================
### Usage: Start gateway with deprecated.yaml:
###   ./target/debug/barbacane compile --spec tests/fixtures/deprecated.yaml -m tests/fixtures/barbacane.yaml -o /tmp/deprecated.bca
###   ./target/debug/barbacane serve --artifact /tmp/deprecated.bca --dev

### Current endpoint - no deprecation headers
# Expected: 200 OK, no Deprecation/Sunset headers
GET {{baseUrl}}/v2/users

###

### Deprecated endpoint (no sunset date)
# Expected: 200 OK with Deprecation: true header
GET {{baseUrl}}/v1/users

###

### Deprecated endpoint with sunset date
# Expected: 200 OK with Deprecation: true AND Sunset headers
GET {{baseUrl}}/v1/users/123

###

### Legacy endpoint with far-future sunset (2030)
# Expected: 200 OK with Deprecation: true AND Sunset: 2030 headers
GET {{baseUrl}}/legacy/status

### ================================================================
### M11: Full CRUD API Tests
### ================================================================
### Usage: Start gateway with full-crud.yaml:
###   ./target/debug/barbacane compile --spec tests/fixtures/full-crud.yaml -m tests/fixtures/barbacane.yaml -o /tmp/full-crud.bca
###   ./target/debug/barbacane serve --artifact /tmp/full-crud.bca --dev

### ================================
### List Users
### ================================

### List users - no params
# Expected: 200 OK
GET {{baseUrl}}/users

###

### List users - with pagination
# Expected: 200 OK
GET {{baseUrl}}/users?limit=10&offset=0

###

### List users - invalid limit (exceeds 100)
# Expected: 400 Bad Request
GET {{baseUrl}}/users?limit=200

### ================================
### Create User
### ================================

### Create user - valid
# Expected: 201 Created
POST {{baseUrl}}/users
Content-Type: application/json

{"email": "test@example.com", "name": "Test User"}

###

### Create user - with optional age
# Expected: 201 Created
POST {{baseUrl}}/users
Content-Type: application/json

{"email": "test@example.com", "name": "Test User", "age": 30}

###

### Create user - missing required name
# Expected: 400 Bad Request
POST {{baseUrl}}/users
Content-Type: application/json

{"email": "test@example.com"}

###

### Create user - invalid email format
# Expected: 400 Bad Request
POST {{baseUrl}}/users
Content-Type: application/json

{"email": "not-an-email", "name": "Test User"}

### ================================
### Get User
### ================================

### Get user - valid UUID
# Expected: 200 OK
GET {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000

###

### Get user - invalid UUID format
# Expected: 400 Bad Request
GET {{baseUrl}}/users/not-a-uuid

### ================================
### Update User
### ================================

### Update user - valid
# Expected: 200 OK
PUT {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000
Content-Type: application/json

{"name": "Updated Name", "email": "updated@example.com"}

###

### Update user - partial update
# Expected: 200 OK
PUT {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000
Content-Type: application/json

{"name": "Just Name"}

### ================================
### Delete User
### ================================

### Delete user
# Expected: 204 No Content
DELETE {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000

### ================================
### Nested Resources (User Orders)
### ================================

### Get user orders
# Expected: 200 OK
GET {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000/orders

###

### Get user orders - with status filter
# Expected: 200 OK
GET {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000/orders?status=pending

###

### Get user orders - invalid status enum
# Expected: 400 Bad Request
GET {{baseUrl}}/users/550e8400-e29b-41d4-a716-446655440000/orders?status=invalid

### ================================================================
### M11: Multi-Spec API Tests
### ================================================================
### Usage: Start gateway with combined specs:
###   ./target/debug/barbacane compile --spec tests/fixtures/multi-spec/users.yaml --spec tests/fixtures/multi-spec/orders.yaml -m tests/fixtures/multi-spec/barbacane.yaml -o /tmp/multi.bca
###   ./target/debug/barbacane serve --artifact /tmp/multi.bca --dev

### ================================
### Users Service (from users.yaml)
### ================================

### List users
# Expected: 200 OK
GET {{baseUrl}}/users

###

### Create user
# Expected: 201 Created
POST {{baseUrl}}/users
Content-Type: application/json

{"name": "Alice", "email": "alice@example.com"}

###

### Get user by ID
# Expected: 200 OK
GET {{baseUrl}}/users/user-123

### ================================
### Orders Service (from orders.yaml)
### ================================

### List orders
# Expected: 200 OK
GET {{baseUrl}}/orders

###

### List orders - with status filter
# Expected: 200 OK
GET {{baseUrl}}/orders?status=pending

###

### Create order
# Expected: 201 Created
POST {{baseUrl}}/orders
Content-Type: application/json

{
  "userId": "user-123",
  "items": [
    {"productId": "prod-1", "quantity": 2},
    {"productId": "prod-2", "quantity": 1}
  ]
}

###

### Get order by ID
# Expected: 200 OK
GET {{baseUrl}}/orders/order-123

###

### Update order status
# Expected: 200 OK
PUT {{baseUrl}}/orders/order-123/status
Content-Type: application/json

{"status": "shipped"}

### ================================
### Combined Health Check
### ================================

### Gateway health (should show combined routes count)
# Expected: 200 OK with routes from both specs
GET {{baseUrl}}/__barbacane/health

###

### OpenAPI specs list
# Expected: 200 OK with list of both specs
GET {{baseUrl}}/__barbacane/openapi
