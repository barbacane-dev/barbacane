# OpenAPI 3.1.x Test Fixture
# Tests 3.1-specific features: JSON Schema 2020-12, type arrays, examples, const,
# exclusiveMinimum as number, license.identifier, webhooks, unevaluatedProperties
openapi: "3.1.0"
info:
  title: Train Travel API
  description: |
    API for finding and booking train trips across Europe.

    ## Features
    - Real-time availability
    - Multi-carrier support
    - Instant booking confirmation
  version: "2.0.0"
  contact:
    name: Train Support
    url: https://example.com/support
    email: support@example.com
  license:
    name: Apache 2.0
    identifier: Apache-2.0  # 3.1 supports SPDX identifier

servers:
  - url: https://api.trains.example.com/v2
    description: Production
  - url: https://staging-api.trains.example.com/v2
    description: Staging

# Global Barbacane middlewares
x-barbacane-middlewares:
  - name: rate-limit
    config:
      requests_per_minute: 200
      burst: 50
  - name: cors
    config:
      allowed_origins: ["https://app.example.com", "https://admin.example.com"]
      allowed_methods: ["GET", "POST", "PUT", "DELETE"]
  - name: request-id
    config:
      header: X-Request-ID

tags:
  - name: Stations
    description: Find and filter train stations across Europe.
  - name: Trips
    description: Timetables and routes for train trips.
  - name: Bookings
    description: Create and manage bookings for train trips.
  - name: Payments
    description: Process payments for bookings.

paths:
  /stations:
    get:
      summary: Get a list of train stations
      operationId: getStations
      tags:
        - Stations
      x-barbacane-dispatch:
        name: http
        config:
          upstream: trains-backend
          path: /api/v2/stations
      x-barbacane-middlewares:
        - name: cache
          config:
            ttl: 600
            vary: ["Accept-Language"]
      parameters:
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: country
          in: query
          description: Filter by country code
          schema:
            type: string
            pattern: "^[A-Z]{2}$"
          # 3.1 supports examples array
          examples:
            - DE
            - FR
            - IT
        - name: search
          in: query
          description: Search by name or city
          schema:
            type: string
            minLength: 2
          examples:
            - Berlin
            - Paris Gare
        - name: has_wifi
          in: query
          description: Filter stations with WiFi
          schema:
            type: boolean
      responses:
        "200":
          description: A list of stations
          headers:
            X-Total-Count:
              schema:
                type: integer
              description: Total number of stations
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                  - meta
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Station"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"
                  links:
                    $ref: "#/components/schemas/PaginationLinks"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"

  /stations/{stationId}:
    get:
      summary: Get a specific station
      operationId: getStation
      tags:
        - Stations
      x-barbacane-dispatch:
        name: http
        config:
          upstream: trains-backend
          path: /api/v2/stations/{stationId}
      x-barbacane-middlewares:
        - name: cache
          config:
            ttl: 3600
      parameters:
        - name: stationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          examples:
            - efdbb9d1-02c2-4bc3-afb7-6788d8782b1e
            - b2e783e1-c824-4d63-b37a-d8d698862f1d
      responses:
        "200":
          description: Station details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Station"
        "404":
          $ref: "#/components/responses/NotFound"

  /trips:
    get:
      summary: Search for available trips
      operationId: searchTrips
      tags:
        - Trips
      x-barbacane-dispatch:
        name: http
        config:
          upstream: trains-backend
          path: /api/v2/trips
          timeout: 15s
      parameters:
        - name: origin
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: destination
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: time
          in: query
          description: Preferred departure time
          schema:
            type: string
            format: time
          examples:
            - "09:00"
            - "14:30"
        - name: passengers
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 9
            default: 1
        - name: class
          in: query
          schema:
            type: string
            enum:
              - first
              - second
            default: second
        - name: direct_only
          in: query
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Available trips
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Trip"
                  meta:
                    type: object
                    properties:
                      search_id:
                        type: string
                        format: uuid
                      cached:
                        type: boolean

  /bookings:
    get:
      summary: List user bookings
      operationId: listBookings
      tags:
        - Bookings
      x-barbacane-dispatch:
        name: http
        config:
          upstream: trains-backend
          path: /api/v2/bookings
      x-barbacane-middlewares:
        - name: auth-jwt
          config:
            required: true
      parameters:
        - name: status
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [pending, confirmed, cancelled, completed]
          style: form
          explode: true
      responses:
        "200":
          description: List of bookings
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Booking"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      summary: Create a new booking
      operationId: createBooking
      tags:
        - Bookings
      x-barbacane-dispatch:
        name: http
        config:
          upstream: trains-backend
          path: /api/v2/bookings
          method: POST
      x-barbacane-middlewares:
        - name: auth-jwt
          config:
            required: true
            scopes: ["bookings:write"]
        - name: idempotency
          config:
            header: Idempotency-Key
            ttl: 86400
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BookingRequest"
      responses:
        "201":
          description: Booking created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Booking"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/Conflict"

  /bookings/{bookingId}:
    parameters:
      - name: bookingId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get booking details
      operationId: getBooking
      tags:
        - Bookings
      x-barbacane-dispatch:
        name: http
        config:
          upstream: trains-backend
          path: /api/v2/bookings/{bookingId}
      x-barbacane-middlewares:
        - name: auth-jwt
          config:
            required: true
      responses:
        "200":
          description: Booking details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Booking"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      summary: Cancel a booking
      operationId: cancelBooking
      tags:
        - Bookings
      x-barbacane-dispatch:
        name: http
        config:
          upstream: trains-backend
          path: /api/v2/bookings/{bookingId}
          method: DELETE
      x-barbacane-middlewares:
        - name: auth-jwt
          config:
            required: true
            scopes: ["bookings:write"]
      responses:
        "204":
          description: Booking cancelled
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Cannot cancel - booking already processed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /bookings/{bookingId}/payment:
    parameters:
      - name: bookingId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      summary: Pay for a booking
      operationId: createPayment
      tags:
        - Payments
      x-barbacane-dispatch:
        name: http
        config:
          upstream: trains-backend
          path: /api/v2/bookings/{bookingId}/payment
          method: POST
          timeout: 30s
      x-barbacane-middlewares:
        - name: auth-jwt
          config:
            required: true
        - name: idempotency
          config:
            header: Idempotency-Key
            ttl: 86400
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PaymentRequest"
      responses:
        "200":
          description: Payment processed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Payment"
        "400":
          $ref: "#/components/responses/BadRequest"
        "402":
          description: Payment failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentError"

# 3.1 webhooks support
webhooks:
  bookingConfirmed:
    post:
      summary: Booking confirmed webhook
      operationId: onBookingConfirmed
      tags:
        - Bookings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - event
                - data
              properties:
                event:
                  # 3.1 const keyword
                  const: booking.confirmed
                data:
                  $ref: "#/components/schemas/Booking"
                timestamp:
                  type: string
                  format: date-time
      responses:
        "200":
          description: Webhook received

  paymentReceived:
    post:
      summary: Payment received webhook
      operationId: onPaymentReceived
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                event:
                  const: payment.received
                data:
                  $ref: "#/components/schemas/Payment"
      responses:
        "200":
          description: Webhook received

components:
  schemas:
    Station:
      type: object
      required:
        - id
        - name
        - country_code
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          examples:
            - Berlin Hauptbahnhof
            - Paris Gare du Nord
            - Milano Centrale
        # 3.1 type array for nullable
        address:
          type: ["string", "null"]
          description: Full address, may be null for minor stations
        country_code:
          type: string
          pattern: "^[A-Z]{2}$"
          examples:
            - DE
            - FR
            - IT
        timezone:
          type: string
          examples:
            - Europe/Berlin
            - Europe/Paris
        coordinates:
          $ref: "#/components/schemas/Coordinates"
        amenities:
          type: array
          items:
            type: string
          examples:
            - [wifi, restaurant, lockers]
            - [wifi, parking]

    Coordinates:
      type: object
      properties:
        latitude:
          type: number
          minimum: -90
          maximum: 90
        longitude:
          type: number
          minimum: -180
          maximum: 180

    Trip:
      type: object
      required:
        - id
        - origin
        - destination
        - departure_time
        - arrival_time
        - price
      properties:
        id:
          type: string
          format: uuid
        origin:
          $ref: "#/components/schemas/Station"
        destination:
          $ref: "#/components/schemas/Station"
        departure_time:
          type: string
          format: date-time
        arrival_time:
          type: string
          format: date-time
        duration_minutes:
          type: integer
          minimum: 1
        operator:
          type: string
          examples:
            - Deutsche Bahn
            - SNCF
            - Trenitalia
        train_number:
          type: ["string", "null"]
        price:
          $ref: "#/components/schemas/Price"
        class:
          type: string
          enum:
            - first
            - second
        available_seats:
          type: ["integer", "null"]
          minimum: 0
        stops:
          type: array
          items:
            $ref: "#/components/schemas/TripStop"
        amenities:
          type: array
          items:
            $ref: "#/components/schemas/Amenity"

    TripStop:
      type: object
      properties:
        station:
          $ref: "#/components/schemas/Station"
        arrival_time:
          type: ["string", "null"]
          format: date-time
        departure_time:
          type: ["string", "null"]
          format: date-time
        platform:
          type: ["string", "null"]

    Amenity:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum:
            - wifi
            - restaurant
            - power_outlets
            - bicycle_storage
            - pet_friendly
            - quiet_zone
        description:
          type: ["string", "null"]
        available:
          type: boolean
          default: true

    Price:
      type: object
      required:
        - amount
        - currency
      properties:
        amount:
          type: number
          # 3.1 exclusiveMinimum as number
          exclusiveMinimum: 0
        currency:
          type: string
          enum: [EUR, GBP, CHF, SEK, NOK, DKK]
        original_amount:
          type: ["number", "null"]
          description: Original price before discount

    Booking:
      type: object
      required:
        - id
        - trip_id
        - status
      # 3.1 unevaluatedProperties
      unevaluatedProperties: false
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        trip_id:
          type: string
          format: uuid
        passengers:
          type: array
          items:
            $ref: "#/components/schemas/Passenger"
          minItems: 1
          maxItems: 9
        status:
          type: string
          enum:
            - pending
            - confirmed
            - cancelled
            - completed
        total_price:
          $ref: "#/components/schemas/Price"
        created_at:
          type: string
          format: date-time
          readOnly: true
        expires_at:
          type: ["string", "null"]
          format: date-time
        confirmed_at:
          type: ["string", "null"]
          format: date-time
          readOnly: true

    Passenger:
      type: object
      required:
        - name
        - email
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        email:
          type: string
          format: email
        phone:
          type: ["string", "null"]
        seat_preference:
          type: string
          enum:
            - window
            - aisle
            - no_preference
          default: no_preference
        special_requirements:
          type: array
          items:
            type: string
            enum:
              - wheelchair
              - visual_impairment
              - hearing_impairment
              - extra_legroom

    BookingRequest:
      type: object
      required:
        - trip_id
        - passengers
      properties:
        trip_id:
          type: string
          format: uuid
        passengers:
          type: array
          items:
            $ref: "#/components/schemas/Passenger"
          minItems: 1
          maxItems: 9

    PaymentRequest:
      type: object
      required:
        - amount
        - currency
        - method
      properties:
        amount:
          type: number
          exclusiveMinimum: 0
        currency:
          type: string
          enum: [EUR, GBP, CHF]
        method:
          oneOf:
            - $ref: "#/components/schemas/CardPayment"
            - $ref: "#/components/schemas/BankPayment"

    CardPayment:
      type: object
      required:
        - type
        - card_token
      properties:
        type:
          const: card
        card_token:
          type: string
          description: Tokenized card from payment provider

    BankPayment:
      type: object
      required:
        - type
        - iban
      properties:
        type:
          const: bank_transfer
        iban:
          type: string
          pattern: "^[A-Z]{2}[0-9]{2}[A-Z0-9]{4}[0-9]{7}([A-Z0-9]?){0,16}$"

    Payment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        booking_id:
          type: string
          format: uuid
        amount:
          type: number
        currency:
          type: string
        status:
          type: string
          enum:
            - pending
            - succeeded
            - failed
        created_at:
          type: string
          format: date-time

    PaymentError:
      type: object
      properties:
        code:
          type: string
          enum:
            - card_declined
            - insufficient_funds
            - expired_card
            - invalid_card
            - processing_error
        message:
          type: string

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer

    PaginationLinks:
      type: object
      properties:
        self:
          type: string
          format: uri
        first:
          type: string
          format: uri
        prev:
          type: ["string", "null"]
          format: uri
        next:
          type: ["string", "null"]
          format: uri
        last:
          type: string
          format: uri

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: ["object", "null"]
          additionalProperties: true
        request_id:
          type: string

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Error"

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    TooManyRequests:
      description: Too Many Requests
      headers:
        Retry-After:
          schema:
            type: integer
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Remaining:
          schema:
            type: integer
        X-RateLimit-Reset:
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
