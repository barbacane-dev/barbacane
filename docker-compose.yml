# Docker Compose for local development
#
# Usage:
#   docker compose up -d postgres       # Database only (for cargo run dev)
#   docker compose up -d                # Full stack (postgres + control plane)
#
# Data plane requires a pre-compiled artifact:
#   make compile                                  # Uses tests/fixtures/minimal.yaml
#   make compile SPEC=path/to/api.yaml            # Custom spec
#   docker compose --profile with-data-plane up -d

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: barbacane
      POSTGRES_PASSWORD: barbacane
      POSTGRES_DB: barbacane
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U barbacane"]
      interval: 5s
      timeout: 5s
      retries: 5

  control-plane:
    image: barbacane-control
    build:
      context: .
      dockerfile: Dockerfile.control
    environment:
      DATABASE_URL: postgres://barbacane:barbacane@postgres:5432/barbacane
    ports:
      - "80:80"      # Web UI (nginx)
      - "9090:9090"  # API
    depends_on:
      postgres:
        condition: service_healthy

  data-plane:
    image: barbacane
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    volumes:
      - ./artifact.bca:/config/api.bca:ro
    profiles:
      - with-data-plane

volumes:
  postgres_data:
